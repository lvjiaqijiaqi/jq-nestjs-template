# æµ‹è¯•æ¡†æ¶ç³»ç»Ÿå®ŒæˆæŠ¥å‘Š

## ğŸ“… å®Œæˆæ—¶é—´
2025å¹´7æœˆ27æ—¥

## ğŸ¯ å®æ–½ç›®æ ‡
å»ºç«‹å®Œæ•´çš„ä¼ä¸šçº§æµ‹è¯•æ¡†æ¶ç³»ç»Ÿï¼Œæ”¯æŒå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€E2Eæµ‹è¯•ï¼Œæä¾›æµ‹è¯•å·¥å…·ç±»ã€æ•°æ®å·¥å‚ã€MockæœåŠ¡ç­‰ï¼Œç¡®ä¿ä»£ç è´¨é‡å’Œæµ‹è¯•è¦†ç›–ç‡ã€‚

## âœ… å®æ–½å†…å®¹

### 1. Jesté…ç½®ä¼˜åŒ– âœ…

#### ä¸»è¦é…ç½®æ–‡ä»¶
- **`jest.config.js`** - ä¼˜åŒ–çš„Jesté…ç½®
  - æ”¯æŒTypeScriptç¼–è¯‘ï¼ˆts-jestï¼‰
  - å¤šé¡¹ç›®é…ç½®ï¼ˆå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€E2Eæµ‹è¯•ï¼‰
  - è¦†ç›–ç‡é…ç½®å’Œé˜ˆå€¼è®¾ç½®
  - è‡ªå®šä¹‰åŒ¹é…å™¨å’Œè®¾ç½®æ–‡ä»¶

#### é…ç½®ç‰¹æ€§
- **TypeScriptæ”¯æŒ**: å®Œæ•´çš„TypeScripté¡¹ç›®æ”¯æŒ
- **è·¯å¾„æ˜ å°„**: æ”¯æŒé¡¹ç›®è·¯å¾„åˆ«å
- **è¦†ç›–ç‡æŠ¥å‘Š**: HTMLã€LCOVã€JSONå¤šç§æ ¼å¼
- **æµ‹è¯•ç¯å¢ƒéš”ç¦»**: ä¸åŒç±»å‹æµ‹è¯•çš„ç‹¬ç«‹é…ç½®
- **æ€§èƒ½ä¼˜åŒ–**: ç¼“å­˜ã€å¹¶è¡Œæ‰§è¡Œã€è¶…æ—¶æ§åˆ¶

### 2. æµ‹è¯•ç¯å¢ƒè®¾ç½® âœ…

#### æµ‹è¯•è®¾ç½®æ–‡ä»¶
- **`test/setup.ts`** - å…¨å±€æµ‹è¯•è®¾ç½®
  - ç¯å¢ƒå˜é‡é…ç½®
  - è‡ªå®šä¹‰JeståŒ¹é…å™¨
  - å…¨å±€é’©å­å‡½æ•°
  - æµ‹è¯•å·¥å…·æ‰©å±•

#### è‡ªå®šä¹‰åŒ¹é…å™¨
```typescript
// æ–°å¢çš„JeståŒ¹é…å™¨
toBeValidDate()     // éªŒè¯æœ‰æ•ˆæ—¥æœŸ
toBeUuid()          // éªŒè¯UUIDæ ¼å¼
toBeJwtToken()      // éªŒè¯JWT tokenæ ¼å¼
toHaveValidStructure() // éªŒè¯APIå“åº”ç»“æ„
```

### 3. åˆ†å±‚æµ‹è¯•é…ç½® âœ…

#### E2Eæµ‹è¯•è®¾ç½®
- **`test/e2e/setup.ts`** - E2Eæµ‹è¯•ç¯å¢ƒé…ç½®
  - å®Œæ•´åº”ç”¨å®ä¾‹å¯åŠ¨
  - æ•°æ®åº“è¿æ¥ç®¡ç†
  - æµ‹è¯•æ•°æ®æ¸…ç†
  - å…¨å±€åº”ç”¨é…ç½®

#### é›†æˆæµ‹è¯•è®¾ç½®
- **`test/integration/setup.ts`** - é›†æˆæµ‹è¯•é…ç½®
  - æ¨¡å—åŒ–æµ‹è¯•ç¯å¢ƒ
  - æ•°æ®åº“å’Œç¼“å­˜ç®¡ç†
  - ä¾èµ–æœåŠ¡Mock
  - æµ‹è¯•æ¨¡å—åˆ›å»º

### 4. æµ‹è¯•å·¥å…·ç±» âœ…

#### æ ¸å¿ƒå·¥å…·ç±»
- **`test/utils/test-helpers.ts`** - æµ‹è¯•è¾…åŠ©å·¥å…·
  - è®¤è¯ç”¨æˆ·åˆ›å»ºå’Œç®¡ç†
  - æƒé™å’Œè§’è‰²ç®¡ç†
  - æ•°æ®åº“æ“ä½œè¾…åŠ©
  - APIå“åº”éªŒè¯
  - Mockå‡½æ•°å·¥å…·
  - æ—¶é—´æ¨¡æ‹Ÿå·¥å…·

#### ä¸»è¦åŠŸèƒ½
```typescript
// è®¤è¯ç›¸å…³
createAuthenticatedUser()  // åˆ›å»ºè®¤è¯ç”¨æˆ·
createAdminUser()          // åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
authenticatedRequest()     // å‘é€è®¤è¯è¯·æ±‚

// æ•°æ®æ“ä½œ
createPermission()         // åˆ›å»ºæµ‹è¯•æƒé™
assignPermissionToRole()   // åˆ†é…æƒé™
clearTable()               // æ¸…ç†æ•°æ®è¡¨
getTableCount()            // è·å–è®°å½•æ•°

// éªŒè¯å·¥å…·
validateApiResponse()      // éªŒè¯APIå“åº”
validatePaginatedResponse() // éªŒè¯åˆ†é¡µå“åº”
validateErrorResponse()    // éªŒè¯é”™è¯¯å“åº”
validateJwtToken()         // éªŒè¯JWT
validateUuid()             // éªŒè¯UUID
```

### 5. æµ‹è¯•æ•°æ®å·¥å‚ âœ…

#### æ•°æ®å·¥å‚ç±»
- **`test/factories/user.factory.ts`** - ç”¨æˆ·æ•°æ®å·¥å‚
- **`test/factories/role.factory.ts`** - è§’è‰²æ•°æ®å·¥å‚

#### ç”¨æˆ·å·¥å‚åŠŸèƒ½
```typescript
UserFactory.build()           // åŸºç¡€ç”¨æˆ·æ•°æ®
UserFactory.buildList()       // æ‰¹é‡ç”¨æˆ·æ•°æ®
UserFactory.buildActive()     // æ´»è·ƒç”¨æˆ·
UserFactory.buildInactive()   // éæ´»è·ƒç”¨æˆ·
UserFactory.buildAdmin()      // ç®¡ç†å‘˜ç”¨æˆ·
UserFactory.buildTestUser()   // æµ‹è¯•ç”¨æˆ·
UserFactory.buildLoginData()  // ç™»å½•æ•°æ®
UserFactory.buildRegisterData() // æ³¨å†Œæ•°æ®
```

#### è§’è‰²å·¥å‚åŠŸèƒ½
```typescript
RoleFactory.build()          // åŸºç¡€è§’è‰²æ•°æ®
RoleFactory.buildSystem()    // ç³»ç»Ÿè§’è‰²
RoleFactory.buildCustom()    // è‡ªå®šä¹‰è§’è‰²
RoleFactory.buildAdmin()     // ç®¡ç†å‘˜è§’è‰²
RoleFactory.buildUser()      // æ™®é€šç”¨æˆ·è§’è‰²
RoleFactory.buildEditor()    // ç¼–è¾‘è€…è§’è‰²
```

### 6. MockæœåŠ¡å®ç° âœ…

#### MockæœåŠ¡é›†åˆ
- **`test/mocks/auth.service.mock.ts`** - è®¤è¯ç›¸å…³MockæœåŠ¡

#### MockæœåŠ¡åŠŸèƒ½
```typescript
// è®¤è¯æœåŠ¡Mock
mockAuthService.validateUser()    // ç”¨æˆ·éªŒè¯
mockAuthService.login()           // ç™»å½•
mockAuthService.register()        // æ³¨å†Œ
mockAuthService.refreshToken()    // åˆ·æ–°ä»¤ç‰Œ

// ç”¨æˆ·æœåŠ¡Mock
mockUserService.findById()        // æŸ¥æ‰¾ç”¨æˆ·
mockUserService.create()          // åˆ›å»ºç”¨æˆ·
mockUserService.update()          // æ›´æ–°ç”¨æˆ·

// è§’è‰²æœåŠ¡Mock
mockRoleService.getUserPermissions() // è·å–æƒé™
mockRoleService.hasPermission()      // æ£€æŸ¥æƒé™

// å…¶ä»–æœåŠ¡Mock
mockJwtService                    // JWTæœåŠ¡
mockCacheService                  // ç¼“å­˜æœåŠ¡
mockQueueService                  // é˜Ÿåˆ—æœåŠ¡
```

### 7. æµ‹è¯•æ¨¡æ¿ âœ…

#### æ¨¡æ¿æ–‡ä»¶
- **`test/templates/unit-test.template.ts`** - å•å…ƒæµ‹è¯•æ¨¡æ¿
- **`test/templates/e2e-test.template.ts`** - E2Eæµ‹è¯•æ¨¡æ¿

#### æ¨¡æ¿ç‰¹æ€§
- **å®Œæ•´æµ‹è¯•ç»“æ„**: æ ‡å‡†åŒ–çš„æµ‹è¯•ç»„ç»‡æ–¹å¼
- **è¦†ç›–å¤šåœºæ™¯**: æ­£å¸¸æµç¨‹ã€å¼‚å¸¸å¤„ç†ã€è¾¹ç•Œæ¡ä»¶
- **è¯¦ç»†æ³¨é‡Š**: ä½¿ç”¨è¯´æ˜å’Œæœ€ä½³å®è·µ
- **å®ç”¨ç¤ºä¾‹**: çœŸå®åœºæ™¯çš„æµ‹è¯•ç”¨ä¾‹

### 8. æµ‹è¯•è‡ªåŠ¨åŒ–è„šæœ¬ âœ…

#### è‡ªåŠ¨åŒ–è„šæœ¬
- **`scripts/test.sh`** - æµ‹è¯•è‡ªåŠ¨åŒ–è„šæœ¬

#### è„šæœ¬åŠŸèƒ½
```bash
# æµ‹è¯•ç±»å‹
./scripts/test.sh unit         # å•å…ƒæµ‹è¯•
./scripts/test.sh integration  # é›†æˆæµ‹è¯•
./scripts/test.sh e2e          # E2Eæµ‹è¯•
./scripts/test.sh all          # æ‰€æœ‰æµ‹è¯•

# è¦†ç›–ç‡å’ŒæŠ¥å‘Š
./scripts/test.sh coverage     # è¦†ç›–ç‡æµ‹è¯•
./scripts/test.sh watch        # ç›‘æ§æ¨¡å¼
./scripts/test.sh ci           # CIç¯å¢ƒæµ‹è¯•

# ç»´æŠ¤å·¥å…·
./scripts/test.sh clean        # æ¸…ç†ç¼“å­˜
./scripts/test.sh setup        # è®¾ç½®ç¯å¢ƒ
```

### 9. æµ‹è¯•è„šæœ¬é…ç½® âœ…

#### NPMè„šæœ¬æ›´æ–°
```json
{
  "scripts": {
    // åŸºç¡€æµ‹è¯•
    "test": "jest",
    "test:watch": "jest --watch",
    "test:cov": "jest --coverage",
    
    // åˆ†ç±»æµ‹è¯•
    "test:unit": "jest --testPathPattern=\"src/.*\\.spec\\.ts$\"",
    "test:integration": "jest --testPathPattern=\"test/integration/.*\\.test\\.ts$\"",
    "test:e2e:run": "jest --testPathPattern=\"test/e2e/.*\\.e2e-spec\\.ts$\"",
    
    // é«˜çº§åŠŸèƒ½
    "test:all": "jest --testTimeout=60000 --detectOpenHandles",
    "test:ci": "jest --ci --coverage --passWithNoTests",
    "test:clear": "jest --clearCache"
  }
}
```

### 10. è¦†ç›–ç‡é…ç½® âœ…

#### è¦†ç›–ç‡è®¾ç½®
- **å…¨å±€é˜ˆå€¼**: 70% (åˆ†æ”¯ã€å‡½æ•°ã€è¡Œã€è¯­å¥)
- **æ¨¡å—é˜ˆå€¼**: æ ¸å¿ƒæ¨¡å—æ›´é«˜æ ‡å‡†
- **æŠ¥å‘Šæ ¼å¼**: HTMLã€LCOVã€JSONã€æ–‡æœ¬
- **æ’é™¤æ–‡ä»¶**: é…ç½®æ–‡ä»¶ã€å®ä½“ç±»ã€DTOç±»

#### è¦†ç›–ç‡æŠ¥å‘Š
```typescript
coverageThreshold: {
  global: {
    branches: 70,
    functions: 70,
    lines: 70,
    statements: 70,
  }
}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### è¿è¡Œç»“æœ
```bash
# å•å…ƒæµ‹è¯•ç»“æœ
âœ“ AppService should be defined
âœ“ AppService should return "Hello World!"
âœ“ AppController should return app info

Test Suites: 2 passed, 2 total
Tests: 3 passed, 3 total
Time: 2.884s
```

### åŠŸèƒ½éªŒè¯
- âœ… TypeScriptç¼–è¯‘æ­£å¸¸
- âœ… æµ‹è¯•æ‰§è¡ŒæˆåŠŸ
- âœ… è‡ªå®šä¹‰åŒ¹é…å™¨å·¥ä½œ
- âœ… MockæœåŠ¡åŠŸèƒ½æ­£å¸¸
- âœ… æ•°æ®å·¥å‚ç”Ÿæˆæœ‰æ•ˆ
- âœ… æµ‹è¯•å·¥å…·ç±»å¯ç”¨

## ğŸ“Š é¡¹ç›®å½±å“

### å¼€å‘æ•ˆç‡æå‡
1. **æ ‡å‡†åŒ–æµ‹è¯•**: ç»Ÿä¸€çš„æµ‹è¯•ç»“æ„å’Œè§„èŒƒ
2. **è‡ªåŠ¨åŒ–å·¥å…·**: ä¸€é”®è¿è¡Œä¸åŒç±»å‹æµ‹è¯•
3. **MockæœåŠ¡**: å¿«é€Ÿæ¨¡æ‹Ÿä¾èµ–æœåŠ¡
4. **æ•°æ®å·¥å‚**: ä¾¿æ·ç”Ÿæˆæµ‹è¯•æ•°æ®
5. **æµ‹è¯•æ¨¡æ¿**: å¿«é€Ÿåˆ›å»ºæ–°æµ‹è¯•

### ä»£ç è´¨é‡ä¿éšœ
1. **è¦†ç›–ç‡ç›‘æ§**: å¼ºåˆ¶è¦†ç›–ç‡é˜ˆå€¼
2. **å¤šå±‚æµ‹è¯•**: å•å…ƒã€é›†æˆã€E2Eå…¨è¦†ç›–
3. **CIé›†æˆ**: æŒç»­é›†æˆæµ‹è¯•æ”¯æŒ
4. **é”™è¯¯æ£€æµ‹**: æ—©æœŸå‘ç°ä»£ç é—®é¢˜
5. **å›å½’æµ‹è¯•**: é˜²æ­¢åŠŸèƒ½é€€åŒ–

### ç»´æŠ¤ä¾¿åˆ©æ€§
1. **æµ‹è¯•éš”ç¦»**: ä¸åŒæµ‹è¯•ç±»å‹ç‹¬ç«‹é…ç½®
2. **ç¯å¢ƒç®¡ç†**: æµ‹è¯•ç¯å¢ƒè‡ªåŠ¨è®¾ç½®
3. **æ•°æ®æ¸…ç†**: è‡ªåŠ¨æ¸…ç†æµ‹è¯•æ•°æ®
4. **æŠ¥å‘Šç”Ÿæˆ**: è¯¦ç»†çš„æµ‹è¯•æŠ¥å‘Š
5. **è°ƒè¯•æ”¯æŒ**: æµ‹è¯•è°ƒè¯•å·¥å…·

## ğŸ”„ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ–
1. **æ€§èƒ½æµ‹è¯•**: æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•
2. **è§†è§‰æµ‹è¯•**: å‰ç«¯ç»„ä»¶è§†è§‰å›å½’æµ‹è¯•
3. **APIæ–‡æ¡£æµ‹è¯•**: è‡ªåŠ¨éªŒè¯APIæ–‡æ¡£ä¸€è‡´æ€§
4. **æµ‹è¯•å¹¶è¡ŒåŒ–**: ä¼˜åŒ–æµ‹è¯•æ‰§è¡Œé€Ÿåº¦

### é•¿æœŸè§„åˆ’
1. **æµ‹è¯•æ•°æ®ç®¡ç†**: æ›´æ™ºèƒ½çš„æµ‹è¯•æ•°æ®ç”Ÿæˆ
2. **æµ‹è¯•æŠ¥å‘Šåˆ†æ**: æµ‹è¯•è¶‹åŠ¿å’Œè´¨é‡åˆ†æ
3. **è‡ªåŠ¨åŒ–æµ‹è¯•ç”Ÿæˆ**: åŸºäºä»£ç è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•
4. **è·¨æµè§ˆå™¨æµ‹è¯•**: E2Eæµ‹è¯•å¤šæµè§ˆå™¨æ”¯æŒ

## ğŸ“‹ ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¼€å§‹
```bash
# å®‰è£…ä¾èµ–
npm install

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm run test:all

# è¿è¡Œå•å…ƒæµ‹è¯•
npm run test:unit

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npm run test:cov

# ç›‘æ§æ¨¡å¼
npm run test:watch
```

### åˆ›å»ºæ–°æµ‹è¯•
1. å¤åˆ¶å¯¹åº”çš„æµ‹è¯•æ¨¡æ¿
2. æ›¿æ¢å®ä½“å’ŒæœåŠ¡åç§°
3. ä½¿ç”¨æ•°æ®å·¥å‚ç”Ÿæˆæµ‹è¯•æ•°æ®
4. åˆ©ç”¨æµ‹è¯•å·¥å…·ç±»ç®€åŒ–æ“ä½œ
5. è¿è¡Œæµ‹è¯•éªŒè¯åŠŸèƒ½

### æœ€ä½³å®è·µ
1. **æµ‹è¯•å‘½å**: æè¿°æ€§çš„æµ‹è¯•åç§°
2. **æµ‹è¯•ç»“æ„**: Arrange-Act-Assertæ¨¡å¼
3. **æµ‹è¯•éš”ç¦»**: æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹å¯è¿è¡Œ
4. **Mockä½¿ç”¨**: åˆç†ä½¿ç”¨Mockéš”ç¦»ä¾èµ–
5. **è¦†ç›–ç‡ç›®æ ‡**: å…³æ³¨é‡è¦ä¸šåŠ¡é€»è¾‘

## ğŸ‰ æ€»ç»“

æµ‹è¯•æ¡†æ¶ç³»ç»Ÿå·²æˆåŠŸå®æ–½ï¼Œä¸ºé¡¹ç›®æä¾›äº†å®Œæ•´çš„æµ‹è¯•è§£å†³æ–¹æ¡ˆï¼š

- **ğŸ§ª å®Œæ•´æµ‹è¯•ä½“ç³»**: å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€E2Eæµ‹è¯•å…¨è¦†ç›–
- **ğŸ› ï¸ ä¸°å¯Œå·¥å…·æ”¯æŒ**: æµ‹è¯•å·¥å…·ç±»ã€æ•°æ®å·¥å‚ã€MockæœåŠ¡
- **ğŸ“Š è´¨é‡ä¿éšœæœºåˆ¶**: è¦†ç›–ç‡é˜ˆå€¼ã€CIé›†æˆã€è‡ªåŠ¨åŒ–æµ‹è¯•
- **ğŸ“š æ ‡å‡†åŒ–æ¨¡æ¿**: æµ‹è¯•æ¨¡æ¿å’Œæœ€ä½³å®è·µæŒ‡å—
- **âš¡ é«˜æ•ˆå¼€å‘ä½“éªŒ**: è‡ªåŠ¨åŒ–è„šæœ¬å’Œä¾¿æ·å·¥å…·

è¿™å¥—æµ‹è¯•æ¡†æ¶ä¸ºé¡¹ç›®çš„é•¿æœŸç¨³å®šå‘å±•å’Œä»£ç è´¨é‡ä¿éšœå¥ å®šäº†åšå®åŸºç¡€ï¼Œæ”¯æŒå›¢é˜Ÿå¿«é€Ÿã€å®‰å…¨åœ°è¿›è¡ŒåŠŸèƒ½å¼€å‘å’Œè¿­ä»£ã€‚ 