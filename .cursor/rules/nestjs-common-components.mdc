---
description: 
globs: 
alwaysApply: false
---
# NestJS é€šç”¨ç»„ä»¶åŠŸèƒ½æŒ‡å—

## ğŸ“ ç»„ä»¶æ¶æ„æ¦‚è§ˆ

`src/common/` ç›®å½•åŒ…å«äº†é¡¹ç›®ä¸­å¯å¤ç”¨çš„ NestJS æ ¸å¿ƒç»„ä»¶ï¼Œä¸ºæ•´ä¸ªåº”ç”¨æä¾›åŸºç¡€åŠŸèƒ½æ”¯æ’‘ã€‚

### ğŸ—ï¸ ç›®å½•ç»“æ„

```
src/common/
â”œâ”€â”€ decorators/          # è‡ªå®šä¹‰è£…é¥°å™¨
â”œâ”€â”€ dto/                # æ•°æ®ä¼ è¾“å¯¹è±¡åŸºç±»
â”œâ”€â”€ entities/           # å®ä½“åŸºç±»
â”œâ”€â”€ filters/            # å¼‚å¸¸è¿‡æ»¤å™¨
â”œâ”€â”€ interceptors/       # æ‹¦æˆªå™¨
â”œâ”€â”€ middleware/         # ä¸­é—´ä»¶
â”œâ”€â”€ pipes/              # ç®¡é“ï¼ˆç©ºï¼‰
â”œâ”€â”€ guards/             # å®ˆå«ï¼ˆç©ºï¼‰
â”œâ”€â”€ repositories/       # ä»“åº“åŸºç±»
â”œâ”€â”€ validators/         # è‡ªå®šä¹‰éªŒè¯å™¨
â””â”€â”€ constants/          # å¸¸é‡å®šä¹‰
```

## ğŸ”§ **1. æ‹¦æˆªå™¨ (Interceptors)**

### ğŸ“ ä½ç½®ï¼š`src/common/interceptors/`

#### **ğŸŒŸ ResponseTransformInterceptorï¼ˆå“åº”è½¬æ¢æ‹¦æˆªå™¨ï¼‰**

**åŠŸèƒ½**ï¼šè‡ªåŠ¨å°†æ§åˆ¶å™¨è¿”å›å€¼åŒ…è£…æˆç»Ÿä¸€çš„å“åº”æ ¼å¼

```typescript
// ä½¿ç”¨ç¤ºä¾‹
@Injectable()
export class ResponseTransformInterceptor<T> implements NestInterceptor<T, ResponseDto<T>> {
  // è‡ªåŠ¨åŒ…è£…å“åº”ä¸ºæ ‡å‡†æ ¼å¼
  return ResponseDto.success(data, 'æ“ä½œæˆåŠŸ', path, requestId);
}

// è·³è¿‡è½¬æ¢è£…é¥°å™¨
@SkipResponseTransform()
@Get('raw-data')
async getRawData() {
  return { raw: 'data' }; // ä¸ä¼šè¢«åŒ…è£…
}
```

**ç‰¹æ€§**ï¼š
- ğŸ”„ è‡ªåŠ¨å“åº”æ ¼å¼æ ‡å‡†åŒ–
- ğŸ†” è‡ªåŠ¨æ·»åŠ è¯·æ±‚IDå’Œæ—¶é—´æˆ³
- â­ï¸ æ”¯æŒè·³è¿‡è½¬æ¢ï¼ˆ`@SkipResponseTransform()`ï¼‰
- ğŸ›¡ï¸ æ™ºèƒ½æ£€æµ‹å·²åŒ…è£…çš„å“åº”

#### **ğŸ” XssFilterInterceptorï¼ˆXSSè¿‡æ»¤æ‹¦æˆªå™¨ï¼‰**

**åŠŸèƒ½**ï¼šé˜²æ­¢XSSæ”»å‡»ï¼Œè¿‡æ»¤å±é™©çš„HTMLæ ‡ç­¾å’Œè„šæœ¬

#### **ğŸ“Š CacheInterceptorï¼ˆç¼“å­˜æ‹¦æˆªå™¨ï¼‰**

**åŠŸèƒ½**ï¼šæä¾›åŸºäºRedisçš„HTTPå“åº”ç¼“å­˜

#### **ğŸ·ï¸ ApiVersionInterceptorï¼ˆAPIç‰ˆæœ¬æ‹¦æˆªå™¨ï¼‰**

**åŠŸèƒ½**ï¼šå¤„ç†APIç‰ˆæœ¬æ§åˆ¶å’ŒåºŸå¼ƒè­¦å‘Š

## ğŸ›¡ï¸ **2. è¿‡æ»¤å™¨ (Filters)**

### ğŸ“ ä½ç½®ï¼š`src/common/filters/`

#### **âš ï¸ HttpExceptionFilterï¼ˆHTTPå¼‚å¸¸è¿‡æ»¤å™¨ï¼‰**

**åŠŸèƒ½**ï¼šå…¨å±€å¼‚å¸¸å¤„ç†ï¼Œç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼

```typescript
@Catch()
export class HttpExceptionFilter implements ExceptionFilter {
  catch(exception: unknown, host: ArgumentsHost): void {
    // ç»Ÿä¸€å¤„ç†æ‰€æœ‰HTTPå¼‚å¸¸
    // è¿”å›æ ‡å‡†åŒ–é”™è¯¯å“åº”
    return ResponseDto.error(errorCode, path, requestId, details);
  }
}
```

**ç‰¹æ€§**ï¼š
- ğŸ¯ æ•è·æ‰€æœ‰æœªå¤„ç†å¼‚å¸¸
- ğŸ“‹ æ ‡å‡†åŒ–é”™è¯¯å“åº”æ ¼å¼
- ğŸ” è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•
- ğŸ“Š åŒºåˆ†éªŒè¯é”™è¯¯å’Œä¸šåŠ¡é”™è¯¯
- ğŸ†” è‡ªåŠ¨æ·»åŠ è¯·æ±‚è¿½è¸ªä¿¡æ¯

## ğŸ¨ **3. è£…é¥°å™¨ (Decorators)**

### ğŸ“ ä½ç½®ï¼š`src/common/decorators/`

#### **ğŸ“š APIå“åº”è£…é¥°å™¨**

```typescript
// APIæˆåŠŸå“åº”
@ApiSuccessResponse(UserDto, 'è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ')

// APIåˆ›å»ºå“åº”
@ApiCreatedResponse(UserDto, 'ç”¨æˆ·åˆ›å»ºæˆåŠŸ')

// APIé”™è¯¯å“åº”ï¼ˆè‡ªåŠ¨æ·»åŠ å¸¸è§é”™è¯¯çŠ¶æ€ç ï¼‰
@ApiErrorResponses()

// å®Œæ•´APIæ–‡æ¡£è£…é¥°å™¨
@ApiDocumentation('è·å–ç”¨æˆ·åˆ—è¡¨', 'ç”¨æˆ·ç®¡ç†', UserDto, 'è·å–æˆåŠŸ')
```

**ç‰¹æ€§**ï¼š
- ğŸ“– è‡ªåŠ¨ç”ŸæˆSwaggeræ–‡æ¡£
- ğŸ¯ ç»Ÿä¸€å“åº”æ ¼å¼å®šä¹‰
- ğŸ“‹ åŒ…å«å¸¸è§HTTPçŠ¶æ€ç 
- ğŸ”— æ”¯æŒå¤åˆè£…é¥°å™¨ä½¿ç”¨

#### **ğŸ·ï¸ APIç‰ˆæœ¬è£…é¥°å™¨**

```typescript
@ApiVersion('1')           // æ ‡è®°APIç‰ˆæœ¬
@DeprecatedApiVersion('å°†åœ¨v2ä¸­ç§»é™¤') // æ ‡è®°åºŸå¼ƒAPI
```

#### **ğŸ’¾ ç¼“å­˜è£…é¥°å™¨**

```typescript
@Cacheable(key: 'user:${id}', ttl: 300)  // ç¼“å­˜æ–¹æ³•ç»“æœ
@CacheEvict(key: 'user:${id}')           // æ¸…é™¤ç¼“å­˜
@CachePut(key: 'user:${id}')             // æ›´æ–°ç¼“å­˜
@CacheConfig(keyPrefix: 'user:')         // ç¼“å­˜é…ç½®
```

## ğŸ“¦ **4. DTO (æ•°æ®ä¼ è¾“å¯¹è±¡)**

### ğŸ“ ä½ç½®ï¼š`src/common/dto/`

#### **ğŸ—ï¸ BaseDtoï¼ˆåŸºç¡€DTOï¼‰**

```typescript
export class BaseDto {
  id?: string;          // é€šç”¨IDå­—æ®µ
  createdAt?: Date;     // åˆ›å»ºæ—¶é—´
  updatedAt?: Date;     // æ›´æ–°æ—¶é—´
}

export class CreateBaseDto {
  createdBy?: string;   // åˆ›å»ºè€…ID
}

export class UpdateBaseDto {
  updatedBy?: string;   // æ›´æ–°è€…ID
}
```

**ç”¨é€”**ï¼š
- ğŸ—ï¸ æ‰€æœ‰DTOçš„åŸºç¡€ç±»
- ğŸ“… ç»Ÿä¸€æ—¶é—´å­—æ®µæ ¼å¼
- ğŸ‘¤ ç»Ÿä¸€æ“ä½œè€…è®°å½•

#### **ğŸ“‹ PaginationDtoï¼ˆåˆ†é¡µDTOï¼‰**

```typescript
export class PaginationDto {
  page: number = 1;           // é¡µç 
  pageSize: number = 10;      // æ¯é¡µå¤§å°
  sortBy?: string;           // æ’åºå­—æ®µ
  sortOrder?: 'ASC' | 'DESC'; // æ’åºæ–¹å‘
}
```

**ç‰¹æ€§**ï¼š
- ğŸ“Š æ ‡å‡†åˆ†é¡µå‚æ•°
- âœ… å†…ç½®å‚æ•°éªŒè¯
- ğŸ”„ è‡ªåŠ¨è®¡ç®—skipå’Œtake

#### **ğŸ¯ ResponseDtoï¼ˆå“åº”DTOï¼‰**

```typescript
export class ResponseDto<T> {
  code: number;        // å“åº”ç 
  message: string;     // å“åº”æ¶ˆæ¯
  data: T;            // å“åº”æ•°æ®
  timestamp: string;   // æ—¶é—´æˆ³
  path?: string;      // è¯·æ±‚è·¯å¾„
  requestId?: string; // è¯·æ±‚ID
}
```

**é™æ€æ–¹æ³•**ï¼š
```typescript
ResponseDto.success(data, message);     // æˆåŠŸå“åº”
ResponseDto.error(errorCode, path);     // é”™è¯¯å“åº”
ResponseDto.customError(status, msg);   // è‡ªå®šä¹‰é”™è¯¯
```

## ğŸ—„ï¸ **5. å®ä½“åŸºç±» (Entities)**

### ğŸ“ ä½ç½®ï¼š`src/common/entities/`

#### **ğŸ—ï¸ BaseEntityï¼ˆåŸºç¡€å®ä½“ï¼‰**

```typescript
export abstract class BaseEntity {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @CreateDateColumn({ type: 'timestamp' })
  createdAt: Date;

  @UpdateDateColumn({ type: 'timestamp' })
  updatedAt: Date;

  @DeleteDateColumn({ type: 'timestamp' })
  deletedAt?: Date;
}
```

**ç‰¹æ€§**ï¼š
- ğŸ†” ç»Ÿä¸€UUIDä¸»é”®
- ğŸ“… è‡ªåŠ¨æ—¶é—´æˆ³ç®¡ç†
- ğŸ—‘ï¸ è½¯åˆ é™¤æ”¯æŒ
- ğŸ”„ è‡ªåŠ¨æ›´æ–°æ—¶é—´

## ğŸª **6. ä»“åº“åŸºç±» (Repositories)**

### ğŸ“ ä½ç½®ï¼š`src/common/repositories/`

#### **ğŸ—ï¸ BaseRepositoryï¼ˆåŸºç¡€ä»“åº“ï¼‰**

```typescript
export abstract class BaseRepository<T extends BaseEntity> {
  // é€šç”¨CRUDæ“ä½œ
  async findById(id: string): Promise<T>;
  async findAll(options?: FindManyOptions<T>): Promise<T[]>;
  async create(entity: DeepPartial<T>): Promise<T>;
  async update(id: string, entity: DeepPartial<T>): Promise<T>;
  async softDelete(id: string): Promise<void>;
}
```

**ç‰¹æ€§**ï¼š
- ğŸ”„ æ ‡å‡†CRUDæ“ä½œ
- ğŸ›¡ï¸ ç±»å‹å®‰å…¨
- ğŸ—‘ï¸ è½¯åˆ é™¤æ”¯æŒ
- ğŸ“Š åˆ†é¡µæŸ¥è¯¢æ”¯æŒ

## âœ… **7. éªŒè¯å™¨ (Validators)**

### ğŸ“ ä½ç½®ï¼š`src/common/validators/`

#### **ğŸ” IsStrongPasswordï¼ˆå¼ºå¯†ç éªŒè¯å™¨ï¼‰**

```typescript
export class CreateUserDto {
  @IsStrongPassword({
    message: 'å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦'
  })
  password: string;
}
```

**éªŒè¯è§„åˆ™**ï¼š
- ğŸ“ æœ€å°é•¿åº¦æ£€æŸ¥
- ğŸ”¤ å¤§å°å†™å­—æ¯è¦æ±‚
- ğŸ”¢ æ•°å­—å­—ç¬¦è¦æ±‚
- ğŸ”£ ç‰¹æ®Šå­—ç¬¦è¦æ±‚
- âš™ï¸ å¯é…ç½®éªŒè¯ç­–ç•¥

## ğŸ“ **8. å¸¸é‡å®šä¹‰ (Constants)**

### ğŸ“ ä½ç½®ï¼š`src/common/constants/`

#### **âŒ ERROR_CODESï¼ˆé”™è¯¯ç å®šä¹‰ï¼‰**

```typescript
export const ERROR_CODES = {
  // ç”¨æˆ·æ¨¡å— (10xxxx)
  USER_NOT_FOUND: { code: 100001, message: 'ç”¨æˆ·ä¸å­˜åœ¨' },
  USER_ALREADY_EXISTS: { code: 100002, message: 'ç”¨æˆ·å·²å­˜åœ¨' },
  
  // è®¤è¯æ¨¡å— (20xxxx)
  INVALID_CREDENTIALS: { code: 200001, message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' },
  TOKEN_EXPIRED: { code: 200002, message: 'ä»¤ç‰Œå·²è¿‡æœŸ' },
  
  // æƒé™æ¨¡å— (30xxxx)
  ACCESS_DENIED: { code: 300001, message: 'è®¿é—®è¢«æ‹’ç»' },
  INSUFFICIENT_PERMISSIONS: { code: 300002, message: 'æƒé™ä¸è¶³' },
};
```

**é”™è¯¯ç è§„èŒƒ**ï¼š
- ğŸ“Š 6ä½æ•°å­—æ ¼å¼ï¼šAABBCC
- ğŸ·ï¸ AAï¼šæ¨¡å—ç¼–å·ï¼ˆ10-99ï¼‰
- ğŸ”¢ BBï¼šé”™è¯¯ç±»å‹ï¼ˆ00-99ï¼‰
- ğŸ“‹ CCï¼šå…·ä½“é”™è¯¯ï¼ˆ01-99ï¼‰

## ğŸ”§ **ä½¿ç”¨æœ€ä½³å®è·µ**

### **ğŸ“¦ åœ¨ä¸šåŠ¡æ¨¡å—ä¸­ä½¿ç”¨**

```typescript
// 1. ç»§æ‰¿åŸºç¡€ç±»
export class UserDto extends BaseDto {
  username: string;
  email: string;
}

// 2. ä½¿ç”¨è£…é¥°å™¨
@Controller('users')
@ApiTags('ç”¨æˆ·ç®¡ç†')
export class UserController {
  
  @Get()
  @ApiDocumentation('è·å–ç”¨æˆ·åˆ—è¡¨', 'ç”¨æˆ·ç®¡ç†', 'PaginatedResponseDto<UserDto>')
  async findUsers(@Query() query: PaginationDto) {
    return this.userService.findAll(query);
  }
}

// 3. ç»§æ‰¿ä»“åº“åŸºç±»
@Injectable()
export class UserRepository extends BaseRepository<User> {
  async findByEmail(email: string): Promise<User | null> {
    return this.repository.findOne({ where: { email } });
  }
}

// 4. ä½¿ç”¨éªŒè¯å™¨
export class CreateUserDto {
  @IsEmail()
  email: string;

  @IsStrongPassword()
  password: string;
}
```

### **ğŸ¯ å…¨å±€é…ç½®**

```typescript
// app.module.ts
@Module({
  providers: [
    // å…¨å±€æ‹¦æˆªå™¨
    { provide: APP_INTERCEPTOR, useClass: ResponseTransformInterceptor },
    
    // å…¨å±€è¿‡æ»¤å™¨
    { provide: APP_FILTER, useClass: HttpExceptionFilter },
    
    // å…¨å±€ç®¡é“
    { provide: APP_PIPE, useClass: ValidationPipe },
  ],
})
export class AppModule {}
```

## ğŸ’¡ **ç»„ä»¶æ‰©å±•æŒ‡å—**

### **ğŸ”§ åˆ›å»ºæ–°çš„æ‹¦æˆªå™¨**

```typescript
@Injectable()
export class CustomInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    // å‰ç½®å¤„ç†
    return next.handle().pipe(
      map(data => {
        // åç½®å¤„ç†
        return data;
      })
    );
  }
}
```

### **ğŸ¨ åˆ›å»ºæ–°çš„è£…é¥°å™¨**

```typescript
export function CustomDecorator(options?: any) {
  return applyDecorators(
    // ç»„åˆå¤šä¸ªè£…é¥°å™¨
    ApiOperation({ summary: 'Custom operation' }),
    ApiResponse({ status: 200, description: 'Success' }),
  );
}
```

### **âœ… åˆ›å»ºæ–°çš„éªŒè¯å™¨**

```typescript
@ValidatorConstraint({ name: 'customValidator', async: false })
export class CustomValidatorConstraint implements ValidatorConstraintInterface {
  validate(value: any, args: ValidationArguments): boolean {
    // éªŒè¯é€»è¾‘
    return true;
  }

  defaultMessage(args: ValidationArguments): string {
    return 'Validation failed';
  }
}
```

## ğŸ¯ **å…³é”®ä¼˜åŠ¿**

- ğŸ”„ **ç»Ÿä¸€æ€§**ï¼šæ ‡å‡†åŒ–çš„å“åº”æ ¼å¼å’Œé”™è¯¯å¤„ç†
- ğŸ›¡ï¸ **å®‰å…¨æ€§**ï¼šå†…ç½®XSSé˜²æŠ¤å’Œå¼ºå¯†ç éªŒè¯
- ğŸ“Š **å¯è§‚æµ‹æ€§**ï¼šå®Œæ•´çš„è¯·æ±‚è¿½è¸ªå’ŒæŒ‡æ ‡æ”¶é›†
- ğŸ¨ **å¯æ‰©å±•æ€§**ï¼šåŸºäºç»§æ‰¿å’Œç»„åˆçš„è®¾è®¡æ¨¡å¼
- ğŸ“š **æ–‡æ¡£åŒ–**ï¼šè‡ªåŠ¨ç”ŸæˆSwagger APIæ–‡æ¡£
- ğŸ”§ **é…ç½®åŒ–**ï¼šæ”¯æŒç¯å¢ƒå˜é‡é©±åŠ¨çš„è¡Œä¸ºé…ç½®

**è¿™å¥—é€šç”¨ç»„ä»¶ä¸ºæ‚¨çš„NestJSåº”ç”¨æä¾›äº†å®Œæ•´çš„åŸºç¡€è®¾æ–½æ”¯æ’‘ï¼** ğŸš€
